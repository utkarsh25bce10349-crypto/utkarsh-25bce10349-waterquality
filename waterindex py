"""
Main application file for the Water Quality Dashboard.

This script initializes a Dash application, defines the layout using Dash Bootstrap Components,
and sets up callbacks for interactive components like graphs, tables, and image displays.
It utilizes data loading functions from the `utils.data_loader` module.
"""
import dash
import dash_bootstrap_components as dbc
from dash import dcc, html, callback_context, dash_table
from dash.dependencies import Input, Output, State
import pandas as pd
import os
import numpy as np
import plotly.express as px
import plotly.graph_objects as go
import base64
from io import BytesIO
from PIL import Image
import matplotlib.pyplot as plt
from matplotlib.backends.backend_agg import FigureCanvasAgg as FigureCanvas
import time
from utils.data_loader import (
    load_water_quality_data,
    get_available_lakes,
    get_available_indices,
    get_available_dates,
    get_available_raster_files,
    get_raster_data,
    apply_threshold,
    init as init_data_loader,
    data_cache,
    generate_grid_from_index,
    create_heatmap,
    create_thresholded_image
)

# --- Initialization ---

# Initialize the data loader (starts file watcher in a separate thread)
file_watcher = init_data_loader()

# Initialize the Dash app with Bootstrap theme and responsive meta tags
app = dash.Dash(
    __name__,
    external_stylesheets=[dbc.themes.LUX, dbc.icons.BOOTSTRAP], # Add LUX theme and Bootstrap Icons
    suppress_callback_exceptions=True,
    meta_tags=[{'name': 'viewport', 'content': 'width=device-width, initial-scale=1'}], # For mobile responsiveness
)
server = app.server # Expose server variable for deployment (e.g., Gunicorn)

# Load the initial data from the monitored directory (handle potential errors)
try:
    df = load_water_quality_data()
    if df.empty:
        print("Warning: Initial data load returned an empty DataFrame.")
except Exception as e:
    print(f"Error during initial data load: {e}")
    df = pd.DataFrame() # Initialize with empty df if load fails

# --- Reusable UI Components ---

def create_dropdown(label_text, dropdown_id, options=None, value=None, clearable=False, **kwargs):
    """Creates a Bootstrap styled Column containing a Label and a Dropdown."""
    return dbc.Col([
        dbc.Label(label_text, html_for=dropdown_id),
        dcc.Dropdown(
            id=dropdown_id,
            options=options or [],
            value=value,
            clearable=clearable,
            className="dbc" # Apply dbc styling
        )
    ], **kwargs)

# --- App Layout Definition ---
app.layout = dbc.Container(fluid=True, children=[
    # --- Header Section ---
    html.H1([
        html.I(className="bi bi-droplet-fill me-2"), # Bootstrap icon for visual appeal
        "Water Quality Dashboard"
    ], className="text-center fw-bold my-4"), # Centered, bold title with margin

    # --- Main Tabs for Navigation ---
    dbc.Tabs([
        # --- Tab 1: Tabular Data Visualization ---
        dbc.Tab(label="Tabular Data", children=[
            dbc.Container(fluid=True, className="py-4", children=[
                # --- Controls for Tabular Data ---
                dbc.Card(className="shadow-sm bg-light p-3 mb-4", children=[
                    dbc.CardBody([
                        dbc.Row([
                            create_dropdown("Select Lake:", 'lake-dropdown', md=4),
                            create_dropdown("Select Spectral Index:", 'index-dropdown', md=4),
                            create_dropdown("Select Date:", 'date-dropdown', md=4),
                        ], className="mb-3")
                    ])
                ]),
                dbc.Row([
                    dbc.Col(md=8, children=[
                        dbc.Card(className="shadow-sm bg-light p-3 mb-4", children=[
                            dbc.CardBody([
                                # Graph displaying time series data
                                dcc.Graph(id='water-quality-graph')
                            ])
                        ])
                    ]),
                    # --- Indices Table ---
                    dbc.Col(md=4, children=[
                        dbc.Card(className="shadow-sm bg-light p-3 mb-4", children=[
                            dbc.CardBody([
                                html.H4("Water Quality Indices", className="card-title text-center mb-3"),
                                # Placeholder for the table generated by callback
                                html.Div(id='indices-table')
                            ])
                        ])
                    ]),
                ])
            ])
        ]), # End Tab 1: Tabular Data

        # --- Tab 2: Raster Data Visualization and Processing ---
        dbc.Tab(label="Raster Data", children=[
            dbc.Container(fluid=True, className="py-4", children=[
                # --- Sub-Tabs for Raster Data ---
                dbc.Tabs([
                    # --- Sub-Tab 2.1: View Existing Raster Files ---
                    dbc.Tab(label="Existing Raster Files", children=[
                        dbc.Container(fluid=True, className="py-4", children=[
                            # --- Controls for Existing Raster Files ---
                            dbc.Card(className="shadow-sm bg-light p-3 mb-4", children=[
                                dbc.CardBody([
                                    dbc.Row([
                                        create_dropdown("Select Raster File:", 'raster-dropdown', md=6),
                                        create_dropdown("Thresholding Method:", 'threshold-method-dropdown',
                                                        options=[
                                                            {'label': 'None', 'value': 'none'},
                                                            {'label': 'Otsu', 'value': 'otsu'},
                                                            {'label': 'Manual', 'value': 'manual'}
                                                        ], value='none', md=6),
                                    ], className="mb-3"),
                                    dbc.Row([
                                        dbc.Col(id='threshold-slider-container', style={'display': 'none'}, children=[
                                            dbc.Label("Manual Threshold Value:", html_for='threshold-slider'),
                                            dcc.Slider(
                                                id='threshold-slider', min=0, max=1, step=0.01, value=0.5,
                                                marks={i/10: f"{i/10:.1f}" for i in range(0, 11)},
                                                className="dbc"
                                            ),
                                        ])
                                    ], className="mb-3") # Manual threshold slider (initially hidden)
                                ])
                            ]),
                            # --- Image Display Area ---
                            dbc.Row([
                                # Original Image Display
                                dbc.Col(md=6, children=[
                                    dbc.Card(className="shadow-sm bg-light p-3 mb-4", children=[
                                        dbc.CardBody([
                                            html.H4("Original Image", className="card-title text-center"),
                                            html.Img(id='original-image', style={'width': '100%', 'height': 'auto'}) # Responsive image
                                        ])
                                    ])
                                ]),
                                # Processed Image Display
                                dbc.Col(md=6, children=[
                                    dbc.Card(className="shadow-sm bg-light p-3 mb-4", children=[
                                        dbc.CardBody([
                                            html.H4("Processed Image", className="card-title text-center"),
                                            html.Img(id='processed-image', style={'width': '100%', 'height': 'auto'}) # Responsive image
                                        ])
                                    ])
                                ]),
                            ]),
                            # --- Image Statistics ---
                            dbc.Card(className="shadow-sm bg-light p-3 mb-4", children=[
                                dbc.CardBody([
                                    html.H4("Image Statistics", className="card-title text-center"),
                                    html.Div(id='image-stats') # Placeholder for stats generated by callback
                                ])
                            ])
                        ])
                    ]), # End Sub-Tab 2.1: Existing Raster Files

                    # --- Sub-Tab 2.2: Generate Heatmaps from Tabular Data ---
                    dbc.Tab(label="Generate Heatmaps", children=[
                        dbc.Container(fluid=True, className="py-4", children=[
                            # --- Controls for Heatmap Generation ---
                            dbc.Card(className="shadow-sm bg-light p-3 mb-4", children=[
                                dbc.CardBody([
                                    dbc.Row([
                                        create_dropdown("Select Lake:", 'heatmap-lake-dropdown', md=4),
                                        create_dropdown("Select Spectral Index:", 'heatmap-index-dropdown', md=4),
                                        create_dropdown("Select Date:", 'heatmap-date-dropdown', md=4),
                                    ], className="mb-3"),
                                    dbc.Row([
                                        dbc.Col(md=6, children=[
                                            dbc.Button([html.I(className="bi bi-play-fill me-1"), 'Generate Heatmap'], id='generate-heatmap-button', n_clicks=0, color="primary", className="me-2"),
                                            dbc.Checklist(
                                                id='save-heatmap-checkbox',
                                                options=[{'label': 'Save Images to raster_output/', 'value': 'save'}],
                                                value=[],
                                                inline=True,
                                                switch=True,
                                            )
                                        ])
                                    ])
                                ])
                            ]),
                            # --- Heatmap Image Display Area ---
                            dbc.Row([
                                # Generated Heatmap Display
                                dbc.Col(md=6, children=[
                                    dbc.Card(className="shadow-sm bg-light p-3 mb-4", children=[
                                        dbc.CardBody([
                                            html.H4("Generated Heatmap", className="card-title text-center"),
                                            html.Img(id='heatmap-image', style={'width': '100%', 'height': 'auto'}) # Responsive image
                                        ])
                                    ])
                                ]),
                                # Thresholded Heatmap Display
                                dbc.Col(md=6, children=[
                                    dbc.Card(className="shadow-sm bg-light p-3 mb-4", children=[
                                        dbc.CardBody([
                                            html.H4("Thresholded Image", className="card-title text-center"),
                                            html.Img(id='thresholded-heatmap-image', style={'width': '100%', 'height': 'auto'}) # Responsive image
                                        ])
                                    ])
                                ]),
                            ]),
                            # --- Heatmap Statistics ---
                            dbc.Card(className="shadow-sm bg-light p-3 mb-4", children=[
                                dbc.CardBody([
                                    html.H4("Heatmap Statistics", className="card-title text-center"),
                                    html.Div(id='heatmap-stats') # Placeholder for stats
                                ])
                            ]),
                            # --- Data Table for Heatmap Source ---
                            dbc.Card(className="shadow-sm bg-light p-3 mb-4", children=[
                                dbc.CardBody([
                                    html.H4("Data Used for Heatmap", className="card-title text-center"),
                                    dash_table.DataTable( # Display the filtered data used
                                        id='heatmap-data-table',
                                        columns=[], data=[], page_size=10,
                                        style_table={'overflowX': 'auto'},
                                        style_cell={'textAlign': 'left', 'padding': '5px', 'whiteSpace': 'normal', 'height': 'auto'},
                                        style_header={'backgroundColor': 'rgb(230, 230, 230)', 'fontWeight': 'bold'},
                                        style_data={'border': '1px solid grey'},
                                        style_as_list_view=True, # Cleaner look
                                    )
                                ])
                            ])
                        ])
                    ]) # End Sub-Tab 2.2: Generate Heatmaps
                ]) # End Raster Sub-Tabs
            ])
        ]), # End Tab 2: Raster Data

        # --- Tab 3: Data File Monitoring Status ---
        dbc.Tab(label="File Monitor", children=[
            dbc.Container(fluid=True, className="py-4", children=[
                dbc.Card(className="shadow-sm bg-light p-3 mb-4", children=[
                    dbc.CardBody([
                        html.H3("Data Directory Monitor", className="card-title text-center"),
                        html.P("This tab shows the files being monitored in the data directory."),
                        html.P("New files added will be automatically detected and processed."),
                        dbc.Button([html.I(className="bi bi-arrow-clockwise me-1"), 'Refresh File List'], id='refresh-button', n_clicks=0, color="secondary", className="mb-3"),
                        dbc.Row([
                            dbc.Col(md=6, children=[
                                dbc.Card(className="shadow-sm bg-light p-3 mb-4", children=[
                                    dbc.CardBody([
                                        html.H4("Tabular Data Files", className="card-title text-center"),
                                        # List of detected tabular files
                                        html.Ul(id='tabular-files-list', className="list-unstyled")
                                    ])
                                ])
                            ]),
                            dbc.Col(md=6, children=[
                                dbc.Card(className="shadow-sm bg-light p-3 mb-4", children=[
                                    dbc.CardBody([
                                        html.H4("Raster Data Files", className="card-title text-center"),
                                        # List of detected raster files
                                        html.Ul(id='raster-files-list', className="list-unstyled")
                                    ])
                                ])
                            ]),
                        ]),
                        # Display last update time of the data cache
                        html.Div([
                            html.P(id='last-updated', className="text-muted text-center")
                        ])
                    ])
                ])
            ])
        ]) # End Tab 3: File Monitor
    ]), # End Main Tabs

    # --- Hidden Components ---
    # Hidden div used to trigger dropdown updates when file list changes
    html.Div(id='refresh-trigger', style={'display': 'none'}, children='0'),

    # Interval component to periodically check for data updates
    dcc.Interval(
        id='interval-component',
        interval=5000,  # Check every 5000 milliseconds (5 seconds)
        n_intervals=0
    )
])

# --- Callbacks ---

# --- Dropdown Update Callback ---
@app.callback(
    [Output('lake-dropdown', 'options'), Output('lake-dropdown', 'value'), # Tab 1
     Output('index-dropdown', 'options'), Output('index-dropdown', 'value'), # Tab 1
     Output('date-dropdown', 'options'), Output('date-dropdown', 'value'),   # Tab 1
     Output('raster-dropdown', 'options'), Output('raster-dropdown', 'value'), # Tab 2.1
     Output('heatmap-lake-dropdown', 'options'), Output('heatmap-lake-dropdown', 'value'), # Tab 2.2
     Output('heatmap-index-dropdown', 'options'), Output('heatmap-index-dropdown', 'value'), # Tab 2.2
     Output('heatmap-date-dropdown', 'options'), Output('heatmap-date-dropdown', 'value')], # Tab 2.2
    [Input('interval-component', 'n_intervals'), # Triggered by timer
     Input('refresh-trigger', 'children')],      # Triggered by file monitor update
    [State('lake-dropdown', 'value'), # Keep current values if possible to avoid resetting user selection
     Output('index-dropdown', 'options'), Output('index-dropdown', 'value'),
     Output('date-dropdown', 'options'), Output('date-dropdown', 'value'),
     Output('raster-dropdown', 'options'), Output('raster-dropdown', 'value'),
     Output('heatmap-lake-dropdown', 'options'), Output('heatmap-lake-dropdown', 'value'),
     Output('heatmap-index-dropdown', 'options'), Output('heatmap-index-dropdown', 'value'),
     Output('heatmap-date-dropdown', 'options'), Output('heatmap-date-dropdown', 'value')],
    [Input('interval-component', 'n_intervals'),
     Input('refresh-trigger', 'children')],
    [State('lake-dropdown', 'value'), # Keep current values if possible
     State('index-dropdown', 'value'),
     State('date-dropdown', 'value'),
     State('raster-dropdown', 'value'),
     State('heatmap-lake-dropdown', 'value'),
     State('heatmap-index-dropdown', 'value'),
     State('heatmap-date-dropdown', 'value')] # State for heatmap date dropdown
)
def update_all_dropdown_options(n_intervals, refresh_trigger,
                                current_lake, current_index, current_date,
                                current_raster, current_heatmap_lake,
                                current_heatmap_index, current_heatmap_date):
    """
    Updates the options and selected values for all dropdowns based on available data.
    Triggered periodically by the interval component or when the file monitor detects changes.
    Attempts to preserve the user's current selections if they are still valid.
    """
    # Fetch the latest available options from the data loader cache
    lakes = get_available_lakes()
    lake_options = [{'label': lake, 'value': lake} for lake in lakes]
    lake_value = current_lake if current_lake in lakes else (lakes[0] if lakes else None)
    heatmap_lake_value = current_heatmap_lake if current_heatmap_lake in lakes else (lakes[0] if lakes else None)

    indices = get_available_indices()
    index_options = [{'label': index, 'value': index} for index in indices]
    index_value = current_index if current_index in indices else (indices[0] if indices else None)
    heatmap_index_value = current_heatmap_index if current_heatmap_index in indices else (indices[0] if indices else None)

    # Get dates potentially filtered by the selected lake for the heatmap tab dropdown
    heatmap_dates = get_available_dates(heatmap_lake_value) # Filter dates based on se